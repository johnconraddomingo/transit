{% for category in categories %}
<details class="category-section">
    <summary class="category-header" style="border-left-color: {{ category.color }};">
        {{ category.name }}
    </summary>
    <div class="metrics-grid">
        {% for metric in category.metrics %}
        <div class="metric-card">
            <div class="metric-title">{{ metric.label }}</div>
            <div class="metric-value">{{ metric.current }}</div>
            <div class="metric-baseline">Baseline: {{ metric.baseline }}</div>
            <div class="metric-average">New Average: {{ metric.average }}</div>

            {% if metric.trend %}
            <div class="metric-trend" style="background-color: {{ metric.trend.color }};">
                {{ metric.trend.pct }} {{ metric.trend.arrow }} ({{ metric.trend.description }})
            </div>
            {% endif %}

            <!-- Historical data collapsible table -->
            <details class="metric-history">
                <summary><strong>Historical Data</strong></summary>
                <div class="metric-history-content">
                    {% for point in metric.chart_data %}
                    <div class="metric-history-item">
                        <span>{{ point.label }}</span>
                        <span>{{ point.value }}</span>
                    </div>
                    {% endfor %}
                </div>
            </details>

            <!-- Line chart -->
            <div class="chart-container">
                <canvas id="{{ metric.chart_id }}" class="chart-canvas" data-chart='{{ metric.chart_data | tojson }}'
                    data-options='{{ metric.chart_options | tojson }}'></canvas>
            </div>
            <div class="chart-legend">
                <div class="legend-item">
                    <span class="legend-line-dot"></span>
                    <span>Actual</span>
                </div>
                <div class="legend-item">
                    <span class="legend-line-dash"></span>
                    <span>Baseline</span>
                </div>
            </div>
            <div class="metric-info-icon" role="button" aria-label="Show description" onclick="toggleDescription(this)">
                i</div>
            <div class="metric-description-popup">{{ metric.description }}</div>
        </div>
        {% endfor %}
    </div>

</details>
{% endfor %}